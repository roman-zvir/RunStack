name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [ "main", "dev", "Dev" ]
  pull_request:
    branches: [ "main", "dev", "Dev" ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  ACR_NAME: 'developmentBranch'
  ACR_LOGIN_SERVER: 'developmentbranch.azurecr.io'
  AZURE_RESOURCE_GROUP: 'NetworkWatcherRG'
  AKS_CLUSTER_NAME: 'devclasterroman'

jobs:
  # Frontend CI Jobs
  frontend-test:
    name: ðŸ§ª Frontend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: ðŸ§ª Run tests
        run: npm test -- --coverage --watchAll=false

      - name: ðŸ—ï¸ Build frontend
        run: npm run build

      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./frontend/coverage/lcov.info
          flags: frontend
          name: frontend-coverage

  frontend-lint:
    name: ðŸ” Frontend Linting
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: ðŸ” Run ESLint
        run: npx eslint src/ --ext .js,.jsx,.ts,.tsx --format=json --output-file=eslint-report.json || true

      - name: ðŸ“Š Upload ESLint results
        uses: actions/upload-artifact@v4
        with:
          name: eslint-report
          path: frontend/eslint-report.json

  # Backend CI Jobs
  backend-test:
    name: ðŸ§ª Backend Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: './backend/requirements.txt'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov flake8 black bandit safety

      - name: ðŸ” Run linting (flake8)
        run: flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=venv,__pycache__,.git

      - name: ðŸŽ¨ Check code formatting (black)
        run: black --check --diff .

      - name: ðŸ”’ Security scan (bandit)
        run: bandit -r . -f json -o bandit-report.json || true

      - name: ðŸ›¡ï¸ Check dependencies (safety)
        run: safety check --json --output safety-report.json || true

      - name: ðŸ§ª Run tests with coverage
        run: pytest --cov=. --cov-report=xml --cov-report=term

      - name: ðŸ“Š Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.xml
          flags: backend
          name: backend-coverage

      - name: ðŸ“Š Upload security reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            backend/bandit-report.json
            backend/safety-report.json

  # Docker Build Jobs
  docker-build:
    name: ðŸ³ Docker Build & Push to Azure Container Registry
    runs-on: ubuntu-latest
    needs: [frontend-test, backend-test]
    if: github.event_name == 'push'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ï¿½ Login to Azure Container Registry
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Determine image tags based on branch
        id: tags
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "backend_image=${{ env.ACR_LOGIN_SERVER }}/backend-prod:latest" >> $GITHUB_OUTPUT
            echo "frontend_image=${{ env.ACR_LOGIN_SERVER }}/frontend-prod:latest" >> $GITHUB_OUTPUT
            echo "backend_image_sha=${{ env.ACR_LOGIN_SERVER }}/backend-prod:${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "frontend_image_sha=${{ env.ACR_LOGIN_SERVER }}/frontend-prod:${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "environment=production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/dev" || "${{ github.ref }}" == "refs/heads/Dev" ]]; then
            echo "backend_image=${{ env.ACR_LOGIN_SERVER }}/backend-dev:latest" >> $GITHUB_OUTPUT
            echo "frontend_image=${{ env.ACR_LOGIN_SERVER }}/frontend-dev:latest" >> $GITHUB_OUTPUT
            echo "backend_image_sha=${{ env.ACR_LOGIN_SERVER }}/backend-dev:${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "frontend_image_sha=${{ env.ACR_LOGIN_SERVER }}/frontend-dev:${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "environment=development" >> $GITHUB_OUTPUT
          else
            echo "backend_image=${{ env.ACR_LOGIN_SERVER }}/backend-dev:latest" >> $GITHUB_OUTPUT
            echo "frontend_image=${{ env.ACR_LOGIN_SERVER }}/frontend-dev:latest" >> $GITHUB_OUTPUT
            echo "backend_image_sha=${{ env.ACR_LOGIN_SERVER }}/backend-dev:${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "frontend_image_sha=${{ env.ACR_LOGIN_SERVER }}/frontend-dev:${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "environment=development" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ—ï¸ Build and push backend image
        run: |
          docker build -t ${{ steps.tags.outputs.backend_image }} \
                       -t ${{ steps.tags.outputs.backend_image_sha }} \
                       ./backend
          docker push ${{ steps.tags.outputs.backend_image }}
          docker push ${{ steps.tags.outputs.backend_image_sha }}

      - name: ðŸ—ï¸ Build and push frontend image
        run: |
          docker build -t ${{ steps.tags.outputs.frontend_image }} \
                       -t ${{ steps.tags.outputs.frontend_image_sha }} \
                       ./frontend
          docker push ${{ steps.tags.outputs.frontend_image }}
          docker push ${{ steps.tags.outputs.frontend_image_sha }}

      - name: ðŸ“ Output deployment info
        run: |
          echo "ðŸš€ Images pushed to ${{ steps.tags.outputs.environment }} environment:"
          echo "ðŸ·ï¸ Backend Image: ${{ steps.tags.outputs.backend_image }}"
          echo "ðŸ·ï¸ Frontend Image: ${{ steps.tags.outputs.frontend_image }}"
          echo "ðŸŒ Environment: ${{ steps.tags.outputs.environment }}"

  # Deployment Job
  deploy:
    name: ðŸš€ Deploy to Azure AKS
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/Dev')

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ”§ Set up kubectl
        uses: azure/setup-kubectl@v3

      - name: ðŸ”§ Get AKS credentials
        run: |
          az aks get-credentials --resource-group ${{ env.AZURE_RESOURCE_GROUP }} --name ${{ env.AKS_CLUSTER_NAME }}

      - name: ðŸ” Determine deployment environment and images
        id: deploy_env
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "backend_image=${{ env.ACR_LOGIN_SERVER }}/backend-prod:${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "frontend_image=${{ env.ACR_LOGIN_SERVER }}/frontend-prod:${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "manifest_path=k8s/prod/" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/dev" || "${{ github.ref }}" == "refs/heads/Dev" ]]; then
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "backend_image=${{ env.ACR_LOGIN_SERVER }}/backend-dev:${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "frontend_image=${{ env.ACR_LOGIN_SERVER }}/frontend-dev:${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "manifest_path=k8s/dev/" >> $GITHUB_OUTPUT
          fi

      - name: ðŸš€ Deploy to Kubernetes
        run: |
          # Update image tags in k8s manifests
          sed -i "s|developmentbranch.azurecr.io/backend.*:.*|${{ steps.deploy_env.outputs.backend_image }}|g" ${{ steps.deploy_env.outputs.manifest_path }}backend-deployment.yaml
          sed -i "s|developmentbranch.azurecr.io/frontend.*:.*|${{ steps.deploy_env.outputs.frontend_image }}|g" ${{ steps.deploy_env.outputs.manifest_path }}frontend-deployment.yaml
          
          # Apply k8s manifests
          kubectl apply -f ${{ steps.deploy_env.outputs.manifest_path }} --validate=true || {
            echo "âš ï¸ Validation failed, applying without validation..."
            kubectl apply -f ${{ steps.deploy_env.outputs.manifest_path }} --validate=false
          }
          
          # Apply common services if not using environment-specific manifests
          if [[ "${{ steps.deploy_env.outputs.manifest_path }}" == "k8s/dev/" ]] || [[ "${{ steps.deploy_env.outputs.manifest_path }}" == "k8s/prod/" ]]; then
            kubectl apply -f k8s/backend-service.yaml --validate=false
            kubectl apply -f k8s/frontend-service.yaml --validate=false
            kubectl apply -f k8s/ingress.yaml --validate=false
          fi
          
          # Wait for rollout
          kubectl rollout status deployment/backend --timeout=300s
          kubectl rollout status deployment/frontend --timeout=300s

      - name: ðŸ”— Get Service URLs
        run: |
          echo "ðŸ“¡ Getting service information..."
          
          # Get external IPs from Azure Load Balancer
          FRONTEND_IP=$(kubectl get service frontend -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
          BACKEND_IP=$(kubectl get service backend -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
          
          echo "Frontend External IP: $FRONTEND_IP"
          echo "Backend External IP: $BACKEND_IP"
          
          # Set environment variables for next step
          echo "FRONTEND_URL=http://$FRONTEND_IP" >> $GITHUB_ENV
          echo "BACKEND_URL=http://$BACKEND_IP" >> $GITHUB_ENV

      - name: ðŸŽ‰ Deployment Success Notification
        if: success()
        run: |
          # Get external IPs again for final notification
          FRONTEND_IP=$(kubectl get service frontend -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
          BACKEND_IP=$(kubectl get service backend -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "pending")
          
          echo "âœ… Deployment successful!"
          echo "ðŸ”— Frontend: http://$FRONTEND_IP"
          echo "ðŸ”— Backend: http://$BACKEND_IP"
          echo " Environment: ${{ steps.deploy_env.outputs.environment }}"
          echo ""
          echo "ðŸ“‹ To check service status manually:"
          echo "kubectl get services"
          echo "kubectl get pods"

  # Notification Job
  notify:
    name: ðŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [frontend-test, frontend-lint, backend-test, docker-build, deploy]
    if: always()

    steps:
      - name: ðŸ“Š Pipeline Summary
        run: |
          echo "## ðŸ“Š Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Tests | ${{ needs.frontend-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend Lint | ${{ needs.frontend-lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend Tests | ${{ needs.backend-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
