name: ðŸ“¦ Pull from Azure & Push to GitHub Packages

on:
  push:
    branches: [ "main", "Dev", "feature/start-using-github-packages" ]  # Only main branch for prod images
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_BASE: ghcr.io/${{ github.repository_owner }}
  ACR_LOGIN_SERVER: 'developmentbranch.azurecr.io'
  ACR_NAME: 'developmentBranch'

jobs:
  pull-and-push:
    name: ï¿½ Pull from Azure & Push to GitHub Packages
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/Dev' || github.ref == 'refs/heads/feature/start-using-github-packages'  #run for main and Dev branches

    strategy:
      matrix:
        include:
          - azure_image: backend-prod
            github_image: backend-prod
          - azure_image: frontend-prod
            github_image: frontend-prod

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ” Login to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: ðŸ” Login to Azure Container Registry
        run: az acr login --name ${{ env.ACR_NAME }}

      - name: ðŸ” Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ“¦ Pull from Azure and Push to GitHub Packages
        run: |
          # Pull the production image from Azure
          AZURE_IMAGE="${{ env.ACR_LOGIN_SERVER }}/${{ matrix.azure_image }}:latest"
          GITHUB_IMAGE="${{ env.IMAGE_BASE }}/${{ matrix.github_image }}:latest"
          GITHUB_IMAGE_SHA="${{ env.IMAGE_BASE }}/${{ matrix.github_image }}:${{ github.sha }}"
          
          echo "ðŸ”½ Pulling from Azure: $AZURE_IMAGE"
          docker pull $AZURE_IMAGE
          
          echo "ðŸ·ï¸ Tagging for GitHub Packages..."
          docker tag $AZURE_IMAGE $GITHUB_IMAGE
          docker tag $AZURE_IMAGE $GITHUB_IMAGE_SHA
          
          echo "ðŸ”¼ Pushing to GitHub Packages..."
          docker push $GITHUB_IMAGE
          docker push $GITHUB_IMAGE_SHA
          
          echo "âœ… Successfully mirrored ${{ matrix.azure_image }} to GitHub Packages"

      - name: ðŸ“ Output image details
        run: |
          echo "ðŸš€ Successfully mirrored from Azure to GitHub Packages:"
          echo "ðŸ“¦ Azure Image: ${{ env.ACR_LOGIN_SERVER }}/${{ matrix.azure_image }}:latest"
          echo "ðŸ“¦ GitHub Image: ${{ env.IMAGE_BASE }}/${{ matrix.github_image }}:latest"
          echo "ï¿½ï¸ GitHub SHA Tag: ${{ env.IMAGE_BASE }}/${{ matrix.github_image }}:${{ github.sha }}"

  summary:
    name: ðŸ“Š Deployment Summary
    runs-on: ubuntu-latest
    needs: pull-and-push
    if: always()
    
    steps:
      - name: ðŸ“ Generate summary
        run: |
          echo "## ðŸ“¦ GitHub Packages Mirror Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ³ Production Images Mirrored from Azure" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source**: Azure Container Registry (\`${{ env.ACR_LOGIN_SERVER }}\`)" >> $GITHUB_STEP_SUMMARY
          echo "**Destination**: GitHub Packages (\`${{ env.REGISTRY }}\`)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ–¥ï¸ **Frontend**: \`${{ env.IMAGE_BASE }}/frontend-prod:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”§ **Backend**: \`${{ env.IMAGE_BASE }}/backend-prod:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Available Tags" >> $GITHUB_STEP_SUMMARY
          echo "- \`latest\` - Latest production build from Azure" >> $GITHUB_STEP_SUMMARY
          echo "- \`${{ github.sha }}\` - This specific commit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— View Packages" >> $GITHUB_STEP_SUMMARY
          echo "[ðŸ“¦ GitHub Packages](https://github.com/${{ github.repository_owner }}?tab=packages&repo_name=${{ github.event.repository.name }})" >> $GITHUB_STEP_SUMMARY
