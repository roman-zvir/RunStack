name: 🚀 Main CI/CD Pipeline

on:
  push:
    branches: [ "main", "dev"]
  pull_request:
    branches: [ "main", "dev"]
  workflow_dispatch:

jobs:
  # Frontend CI
  frontend-ci:
    name: 🎨 Frontend CI
    uses: ./.github/workflows/frontend-ci.yml
    if: contains(github.event.head_commit.modified, 'frontend/') || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'

  # Backend CI
  backend-ci:
    name: 🐍 Backend CI
    uses: ./.github/workflows/backend-ci.yml
    if: contains(github.event.head_commit.modified, 'backend/') || github.event_name == 'workflow_dispatch' || github.event_name == 'pull_request'

  # Docker Build & Push (only on push to main/Dev branches)
  docker-build:
    name: 🐳 Docker Build & Push
    uses: ./.github/workflows/docker-build.yml
    needs: [frontend-ci, backend-ci]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/Dev')
    secrets: inherit

  # Deploy (only on push to main/Dev branches)
  deploy:
    name: � Deploy
    uses: ./.github/workflows/deploy.yml
    needs: [docker-build]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/Dev')
    with:
      backend_image: ${{ needs.docker-build.outputs.backend_image }}
      frontend_image: ${{ needs.docker-build.outputs.frontend_image }}
      environment: ${{ needs.docker-build.outputs.environment }}
    secrets: inherit

  # Notification Job
  notify:
    name: 📢 Pipeline Summary
    runs-on: ubuntu-latest
    needs: [frontend-ci, backend-ci, docker-build, deploy]
    if: always()

    steps:
      - name: 📊 Pipeline Summary
        run: |
          echo "## 📊 Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend CI | ${{ needs.frontend-ci.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend CI | ${{ needs.backend-ci.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker Build | ${{ needs.docker-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
